<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <meta name="theme-color" content="#3B82F6">
    <title>Calendario de Eventos 2025</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            -webkit-tap-highlight-color: transparent;
            -webkit-touch-callout: none;
            overscroll-behavior-y: contain;
        }
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, minmax(0, 1fr));
            gap: 1px;
        }
        
        /* Optimizaci√≥n t√°ctil */
        button, a, [role="button"] {
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
        }
        
        /* Scrollbar personalizado */
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        ::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 3px;
        }
        
        /* Modal para m√≥viles - pantalla completa */
        @media (max-width: 640px) {
            #event-modal .modal-content {
                width: 100vw;
                height: 100vh;
                max-width: 100vw;
                max-height: 100vh;
                margin: 0;
                border-radius: 0;
            }
        }
        
        /* Animaciones suaves */
        #event-modal {
            transition: opacity 0.2s ease;
        }
        
        .event-card {
            -webkit-user-select: none;
            user-select: none;
        }
        
        /* D√≠as del calendario en m√≥vil */
        @media (max-width: 640px) {
            .calendar-day-cell {
                min-height: 80px;
                font-size: 0.75rem;
            }
            .day-number {
                font-size: 0.7rem;
            }
        }
        
        /* Sticky header en m√≥vil */
        .sticky-header {
            position: sticky;
            top: 0;
            z-index: 10;
            background: white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
    </style>
</head>
<body class="bg-gray-100 antialiased">

    <div class="container mx-auto p-2 sm:p-4 md:p-8 max-w-7xl">
        
        <!-- Controles del Calendario - Optimizado para m√≥vil -->
        <div class="sticky-header bg-white rounded-lg shadow-md p-3 sm:p-4 mb-4 sm:mb-6">
            <div class="flex flex-col space-y-3 sm:space-y-0 sm:flex-row sm:items-center sm:justify-between">
                <h1 class="text-xl sm:text-2xl md:text-3xl font-bold text-gray-800 text-center sm:text-left" id="month-year-display"></h1>
                <div class="flex justify-center space-x-2">
                    <button id="prev-month" class="flex-1 sm:flex-none px-3 py-2 sm:px-4 bg-blue-600 text-white rounded-lg shadow-md hover:bg-blue-700 active:bg-blue-800 active:scale-95 transition-all text-sm sm:text-base font-medium">
                        ‚Üê Anterior
                    </button>
                    <button id="next-month" class="flex-1 sm:flex-none px-3 py-2 sm:px-4 bg-blue-600 text-white rounded-lg shadow-md hover:bg-blue-700 active:bg-blue-800 active:scale-95 transition-all text-sm sm:text-base font-medium">
                        Siguiente ‚Üí
                    </button>
                </div>
            </div>
        </div>

        <!-- Calendario -->
        <div class="bg-white rounded-lg shadow-xl overflow-hidden">
            <!-- Encabezados de los d√≠as - Responsivo -->
            <div class="calendar-grid bg-gray-200 sticky top-0 z-10">
                <div class="py-2 px-1 text-center text-[10px] sm:text-sm font-semibold text-gray-600 uppercase">Lu</div>
                <div class="py-2 px-1 text-center text-[10px] sm:text-sm font-semibold text-gray-600 uppercase">Ma</div>
                <div class="py-2 px-1 text-center text-[10px] sm:text-sm font-semibold text-gray-600 uppercase">Mi</div>
                <div class="py-2 px-1 text-center text-[10px] sm:text-sm font-semibold text-gray-600 uppercase">Ju</div>
                <div class="py-2 px-1 text-center text-[10px] sm:text-sm font-semibold text-gray-600 uppercase">Vi</div>
                <div class="py-2 px-1 text-center text-[10px] sm:text-sm font-semibold text-gray-600 uppercase">Sa</div>
                <div class="py-2 px-1 text-center text-[10px] sm:text-sm font-semibold text-gray-600 uppercase">Do</div>
            </div>
            <div id="calendar-body" class="calendar-grid bg-gray-200"></div>
        </div>
    </div>

    <!-- Lista de Inscripciones -->
    <div class="container mx-auto px-2 sm:px-4 md:px-8 max-w-7xl mt-6 sm:mt-10 mb-10 sm:mb-20">
        <div class="flex items-center justify-between mb-4 sm:mb-6 px-2">
            <h2 class="text-xl sm:text-2xl md:text-3xl font-bold text-gray-800">Mis Inscripciones</h2>
            <span id="subscriptions-badge" class="hidden px-3 py-1 bg-blue-600 text-white rounded-full text-xs sm:text-sm font-semibold">0</span>
        </div>
        <div id="subscriptions-list-container" class="bg-white rounded-lg shadow-xl overflow-hidden">
            <div id="empty-list-message" class="p-6 sm:p-8 text-center text-gray-500">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 sm:h-16 sm:w-16 mx-auto mb-3 sm:mb-4 text-gray-300" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" />
                </svg>
                <p class="text-sm sm:text-base">A√∫n no te has inscripto a ninguna fecha de final.</p>
            </div>
        </div>
    </div>

    <!-- Modal de Detalles del Evento - Optimizado para m√≥vil -->
    <div id="event-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-0 sm:p-4 z-50 hidden">
        <div class="modal-content bg-white rounded-none sm:rounded-xl shadow-2xl w-full max-w-md overflow-hidden flex flex-col max-h-screen">
            <!-- Encabezado del Modal -->
            <div class="flex items-center justify-between p-4 sm:p-5 bg-gradient-to-r from-blue-600 to-blue-700 flex-shrink-0">
                <h3 id="modal-title" class="text-lg sm:text-xl font-semibold text-white flex-1 mr-2"></h3>
                <button id="close-modal" class="text-white hover:bg-white hover:bg-opacity-20 rounded-full p-1 transition-colors flex-shrink-0">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 sm:h-7 sm:w-7" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
            
            <!-- Cuerpo del Modal - Scrollable -->
            <div class="p-4 sm:p-6 space-y-4 overflow-y-auto flex-1">
                <div class="flex items-start space-x-3">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-blue-500 mt-0.5 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                    </svg>
                    <div class="flex-1 min-w-0">
                        <strong class="text-gray-500 text-xs sm:text-sm block">Fecha y Hora</strong>
                        <p id="modal-datetime" class="text-gray-800 text-base sm:text-lg font-medium break-words"></p>
                    </div>
                </div>
                <div class="flex items-start space-x-3">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-green-500 mt-0.5 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253" />
                    </svg>
                    <div class="flex-1 min-w-0">
                        <strong class="text-gray-500 text-xs sm:text-sm block">Materia</strong>
                        <p id="modal-subject" class="text-gray-800 text-base sm:text-lg font-medium break-words"></p>
                    </div>
                </div>
                <div class="flex items-start space-x-3">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-purple-500 mt-0.5 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                    </svg>
                    <div class="flex-1 min-w-0">
                        <strong class="text-gray-500 text-xs sm:text-sm block">Profesor</strong>
                        <p id="modal-prof" class="text-gray-800 text-sm sm:text-base break-words"></p>
                    </div>
                </div>
                <div class="flex items-start space-x-3">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-red-500 mt-0.5 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
                    </svg>
                    <div class="flex-1 min-w-0">
                        <strong class="text-gray-500 text-xs sm:text-sm block">Ubicaci√≥n</strong>
                        <p id="modal-location" class="text-gray-800 font-medium text-sm sm:text-base"></p>
                        <p id="modal-address" class="text-gray-600 text-xs sm:text-sm mt-1 break-words"></p>
                        <p id="modal-phone" class="text-gray-600 text-xs sm:text-sm break-words"></p>
                    </div>
                </div>
            </div>
            
            <!-- Pie del Modal -->
            <div class="p-4 sm:p-4 bg-gray-50 flex justify-stretch sm:justify-end flex-shrink-0 border-t">
                <button id="subscribe-button" class="w-full sm:w-auto px-6 py-3 sm:py-2.5 bg-gradient-to-r from-blue-600 to-blue-700 text-white rounded-lg font-medium hover:from-blue-700 hover:to-blue-800 active:scale-95 transition-all disabled:from-gray-400 disabled:to-gray-400 disabled:cursor-not-allowed shadow-md text-base sm:text-sm">
                    Inscribirme
                </button>
            </div>
        </div>
    </div>

    <script>
        // --- BASE DE DATOS DE EVENTOS ---
        const eventsData = [
            { date: "2025-11-25", time: "16:00", div: "A", prof: "GENCARELLI", subj: "INGINF-2014 LABORATORIO IV", loc: "CAMPUS" },
            { date: "2025-11-25", time: "16:00", div: "B", prof: "GENCARELLI", subj: "INGINF-2014 LABORATORIO IV", loc: "CAMPUS" },
            { date: "2025-11-25", time: "18:00", div: "A", prof: "JOAQU√çN", subj: "INGINF-2014 M√âTODOS NUM√âRICOS", loc: "CAMPUS" },
            { date: "2025-11-25", time: "18:00", div: "B", prof: "JOAQU√çN", subj: "INGINF-2014 M√âTODOS NUM√âRICOS", loc: "CAMPUS" },
            { date: "2025-11-25", time: "18:00", div: "A", prof: "B√çSARO", subj: "INGINF-2014 REDES DE COMPUTADORAS", loc: "CAMPUS" },
            { date: "2025-11-25", time: "18:00", div: "B", prof: "B√çSARO", subj: "INGINF-2014 REDES DE COMPUTADORAS", loc: "CAMPUS" },
            { date: "2025-11-26", time: "17:00", div: "A", prof: "GIOVANARDI", subj: "INGINF-2014 TECNOLOG√çA Y SOCIEDAD", loc: "CAMPUS" },
            { date: "2025-11-26", time: "17:00", div: "B", prof: "GIOVANARDI", subj: "INGINF-2014 TECNOLOG√çA Y SOCIEDAD", loc: "CAMPUS" },
            { date: "2025-11-27", time: "09:00", div: "C", prof: "PEREA", subj: "INGINF-2014 OPTATIVA I", loc: "CAMPUS" },
            { date: "2025-12-02", time: "17:00", div: "A", prof: "CALIGARIS", subj: "INGINF-2014 SISTEMAS DE BASES DE DATOS", loc: "CAMPUS" },
            { date: "2025-12-02", time: "17:00", div: "B", prof: "CALIGARIS", subj: "INGINF-2014 SISTEMAS DE BASES DE DATOS", loc: "CAMPUS" },
            { date: "2025-12-02", time: "19:00", div: "A", prof: "KOLLER", subj: "INGINF-2014 PROGRAMACI√ìN DE REDES", loc: "CAMPUS" },
            { date: "2025-12-02", time: "19:00", div: "B", prof: "KOLLER", subj: "INGINF-2014 PROGRAMACI√ìN DE REDES", loc: "CAMPUS" },
            { date: "2025-12-04", time: "17:00", div: "A", prof: "DANIELE", subj: "INGINF-2014 PROGRAMACI√ìN DECLARATIVA", loc: "CAMPUS" },
            { date: "2025-12-04", time: "17:00", div: "B", prof: "DANIELE", subj: "INGINF-2014 PROGRAMACI√ìN DECLARATIVA", loc: "CAMPUS" },
            { date: "2025-12-05", time: "09:00", div: "B", prof: "AMERI LOPEZ LOZANO", subj: "INGINF-2014 INGENIER√çA DE SOFTWARE I", loc: "CAMPUS" },
            { date: "2025-12-05", time: "18:00", div: "A", prof: "ALICIARDI", subj: "INGINF-2014 INGENIER√çA DE SOFTWARE I", loc: "CAMPUS" },
            { date: "2025-12-09", time: "16:00", div: "A", prof: "GENCARELLI", subj: "INGINF-2014 LABORATORIO IV", loc: "CAMPUS" },
            { date: "2025-12-09", time: "16:00", div: "B", prof: "GENCARELLI", subj: "INGINF-2014 LABORATORIO IV", loc: "CAMPUS" },
            { date: "2025-12-09", time: "18:00", div: "A", prof: "JOAQU√çN", subj: "INGINF-2014 M√âTODOS NUM√âRICOS", loc: "CAMPUS" },
            { date: "2025-12-09", time: "18:00", div: "B", prof: "JOAQU√çN", subj: "INGINF-2014 M√âTODOS NUM√âRICOS", loc: "CAMPUS" },
            { date: "2025-12-09", time: "18:00", div: "A", prof: "B√çSARO", subj: "INGINF-2014 REDES DE COMPUTADORAS", loc: "CAMPUS" },
            { date: "2025-12-09", time: "18:00", div: "B", prof: "B√çSARO", subj: "INGINF-2014 REDES DE COMPUTADORAS", loc: "CAMPUS" },
            { date: "2025-12-10", time: "17:00", div: "A", prof: "GIOVANARDI", subj: "INGINF-2014 TECNOLOG√çA Y SOCIEDAD", loc: "CAMPUS" },
            { date: "2025-12-10", time: "17:00", div: "B", prof: "GIOVANARDI", subj: "INGINF-2014 TECNOLOG√çA Y SOCIEDAD", loc: "CAMPUS" },
            { date: "2025-12-11", time: "09:00", div: "C", prof: "PEREA", subj: "INGINF-2014 OPTATIVA I", loc: "CAMPUS" },
            { date: "2025-12-16", time: "17:00", div: "A", prof: "CALIGARIS", subj: "INGINF-2014 SISTEMAS DE BASES DE DATOS", loc: "CAMPUS" },
            { date: "2025-12-16", time: "17:00", div: "B", prof: "CALIGARIS", subj: "INGINF-2014 SISTEMAS DE BASES DE DATOS", loc: "CAMPUS" },
            { date: "2025-12-16", time: "19:00", div: "A", prof: "KOLLER", subj: "INGINF-2014 PROGRAMACI√ìN DE REDES", loc: "CAMPUS" },
            { date: "2025-12-16", time: "19:00", div: "B", prof: "KOLLER", subj: "INGINF-2014 PROGRAMACI√ìN DE REDES", loc: "CAMPUS" },
            { date: "2025-12-18", time: "17:00", div: "A", prof: "DANIELE", subj: "INGINF-2014 PROGRAMACI√ìN DECLARATIVA", loc: "CAMPUS" },
            { date: "2025-12-18", time: "17:00", div: "B", prof: "DANIELE", subj: "INGINF-2014 PROGRAMACI√ìN DECLARATIVA", loc: "CAMPUS" },
            { date: "2025-12-19", time: "18:00", div: "A", prof: "ALICIARDI", subj: "INGINF-2014 INGENIER√çA DE SOFTWARE I", loc: "CAMPUS" },
            { date: "2025-12-19", time: "18:00", div: "B", prof: "AMERI LOPEZ LOZANO", subj: "INGINF-2014 INGENIER√çA DE SOFTWARE I", loc: "CAMPUS" },
            { date: "2025-12-01", time: "15:00", div: "E", prof: "", subj: "INGINF-2014 OPTATIVA I", loc: "CORDOBA" },
            { date: "2025-12-01", time: "15:00", div: "F", prof: "", subj: "INGINF-2014 OPTATIVA I", loc: "CORDOBA" },
            { date: "2025-12-01", time: "15:00", div: "H", prof: "", subj: "INGINF-2014 OPTATIVA I", loc: "CORDOBA" },
            { date: "2025-12-01", time: "15:00", div: "M", prof: "", subj: "INGINF-2014 OPTATIVA I", loc: "CORDOBA" },
            { date: "2025-12-15", time: "15:00", div: "E", prof: "", subj: "INGINF-2014 OPTATIVA I", loc: "CORDOBA" },
            { date: "2025-12-15", time: "15:00", div: "F", prof: "", subj: "INGINF-2014 OPTATIVA I", loc: "CORDOBA" },
            { date: "2025-12-15", time: "15:00", div: "H", prof: "", subj: "INGINF-2014 OPTATIVA I", loc: "CORDOBA" },
            { date: "2025-12-15", time: "15:00", div: "M", prof: "", subj: "INGINF-2014 OPTATIVA I", loc: "CORDOBA" }
        ];

        // --- DETALLES DE UBICACI√ìN ---
        const locationDetails = {
            "CAMPUS": {
                address: "DONATO ALVAREZ 380 - (X-5147) - ARG√úELLO - C√ìRDOBA - ARGENTINA",
                phone: "+54 (351) 4144444"
            },
            "CORDOBA": {
                address: "AV. DONATO ALVAREZ 380 - C√ìRDOBA - C√ìRDOBA - ARGENTINA",
                phone: "+54 (351) 4144444"
            }
        };

        // --- ESTADO DE LA APLICACI√ìN CON LOCALSTORAGE ---
        const STORAGE_KEY = 'calendar_subscriptions';
        
        // Funci√≥n para cargar inscripciones desde localStorage
        function loadSubscriptions() {
            const saved = localStorage.getItem(STORAGE_KEY);
            return saved ? JSON.parse(saved) : [];
        }
        
        // Funci√≥n para guardar inscripciones en localStorage
        function saveSubscriptions() {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(subscriptions));
        }
        
        // Cargar inscripciones guardadas
        let subscriptions = loadSubscriptions();

        // --- L√ìGICA DEL CALENDARIO ---
        
        // Estado inicial: Noviembre 2025 (mes 10)
        let currentDate = new Date(2025, 10, 1);

        // Elementos del DOM
        const calendarBody = document.getElementById('calendar-body');
        const monthYearDisplay = document.getElementById('month-year-display');
        const prevButton = document.getElementById('prev-month');
        const nextButton = document.getElementById('next-month');
        const modal = document.getElementById('event-modal');
        const closeModalButton = document.getElementById('close-modal');
        const subscriptionsListContainer = document.getElementById('subscriptions-list-container');
        const emptyListMessage = document.getElementById('empty-list-message');
        const subscriptionsBadge = document.getElementById('subscriptions-badge');

        // Paleta de colores para los eventos
        const colors = [
            'bg-blue-500', 'bg-green-500', 'bg-red-500', 'bg-purple-500', 
            'bg-pink-500', 'bg-indigo-500', 'bg-teal-500', 'bg-yellow-600'
        ];

        // Funci√≥n para obtener un color basado en el nombre de la materia
        function getColorForSubject(subject) {
            let hash = 0;
            for (let i = 0; i < subject.length; i++) {
                hash = subject.charCodeAt(i) + ((hash << 5) - hash);
            }
            return colors[Math.abs(hash) % colors.length];
        }

        // Funci√≥n para renderizar el calendario
        function renderCalendar(year, month) {
            // Limpiar calendario anterior
            calendarBody.innerHTML = '';
            
            // Configurar el t√≠tulo del mes y a√±o
            const monthName = new Date(year, month).toLocaleString('es-ES', { month: 'long', year: 'numeric' });
            monthYearDisplay.textContent = monthName.charAt(0).toUpperCase() + monthName.slice(1);

            // D√≠as en el mes y d√≠a de inicio (0=Domingo, 1=Lunes...)
            const firstDay = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            
            // Ajustar el primer d√≠a para que la semana comience en Lunes (0=Lunes, 6=Domingo)
            const startingDay = (firstDay === 0) ? 6 : firstDay - 1;

            // 1. Celdas vac√≠as antes del primer d√≠a
            for (let i = 0; i < startingDay; i++) {
                const emptyCell = document.createElement('div');
                emptyCell.className = 'p-1 sm:p-2 h-20 sm:h-28 md:h-36 bg-gray-50 opacity-50';
                calendarBody.appendChild(emptyCell);
            }

            // 2. Celdas de los d√≠as del mes
            for (let day = 1; day <= daysInMonth; day++) {
                const dayCell = document.createElement('div');
                dayCell.className = 'calendar-day-cell p-1 sm:p-2 h-20 sm:h-28 md:h-36 bg-white relative hover:bg-gray-50 transition-colors';
                
                // Formato de fecha ISO (ej: 2025-11-25)
                const isoDate = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                
                // N√∫mero del d√≠a
                const dayNumber = document.createElement('span');
                dayNumber.className = 'day-number text-[10px] sm:text-sm font-semibold text-gray-700 block';
                dayNumber.textContent = day;
                dayCell.appendChild(dayNumber);

                // Contenedor de eventos para scroll
                const eventsContainer = document.createElement('div');
                eventsContainer.className = 'absolute top-6 sm:top-8 left-0.5 sm:left-1 right-0.5 sm:right-1 bottom-0.5 sm:bottom-1 overflow-y-auto space-y-0.5 sm:space-y-1';
                dayCell.appendChild(eventsContainer);

                // Buscar eventos para este d√≠a (FILTRAR LOS QUE YA EST√ÅN INSCRITOS)
                const subscribedSubjects = subscriptions.map(sub => sub.subj);
                const eventsForDay = eventsData.filter(e => 
                    e.date === isoDate && !subscribedSubjects.includes(e.subj)
                );

                // Renderizar eventos
                eventsForDay.forEach(event => {
                    const eventEl = document.createElement('div');
                    const colorClass = getColorForSubject(event.subj);
                    eventEl.className = `event-card ${colorClass} text-white text-[9px] sm:text-[10px] md:text-xs p-0.5 sm:p-1 rounded cursor-pointer hover:opacity-80 active:opacity-70 transition-opacity`;
                    eventEl.textContent = `${event.time} - ${event.div}`;
                    eventEl.title = `${event.subj}`;

                    // Touch events para mejor respuesta t√°ctil
                    let touchStartY = 0;
                    eventEl.addEventListener('touchstart', (e) => {
                        touchStartY = e.touches[0].clientY;
                    });
                    
                    eventEl.addEventListener('touchend', (e) => {
                        const touchEndY = e.changedTouches[0].clientY;
                        // Solo abrir si no fue scroll
                        if (Math.abs(touchEndY - touchStartY) < 10) {
                            e.preventDefault();
                            showModal(event);
                        }
                    });

                    eventEl.addEventListener('click', (e) => {
                        e.stopPropagation();
                        showModal(event);
                    });
                    
                    eventsContainer.appendChild(eventEl);
                });

                calendarBody.appendChild(dayCell);
            }

            // 3. Celdas vac√≠as despu√©s del √∫ltimo d√≠a
            const totalCells = startingDay + daysInMonth;
            const remainingCells = (totalCells % 7 === 0) ? 0 : 7 - (totalCells % 7);
            
            for (let i = 0; i < remainingCells; i++) {
                const emptyCell = document.createElement('div');
                emptyCell.className = 'p-1 sm:p-2 h-20 sm:h-28 md:h-36 bg-gray-50 opacity-50';
                calendarBody.appendChild(emptyCell);
            }
        }

        // --- L√ìGICA DEL MODAL ---
        function showModal(event) {
            const loc = locationDetails[event.loc] || { address: 'No disponible', phone: 'No disponible' };
            
            document.getElementById('modal-title').textContent = `Div. ${event.div} - ${event.time}`;
            document.getElementById('modal-datetime').textContent = `${new Date(event.date + 'T00:00:00').toLocaleDateString('es-ES', { weekday: 'long', day: 'numeric', month: 'long' })} a las ${event.time}h`;
            document.getElementById('modal-subject').textContent = event.subj;
            document.getElementById('modal-prof').textContent = event.prof || 'Profesor no especificado';
            document.getElementById('modal-location').textContent = event.loc;
            document.getElementById('modal-address').textContent = loc.address;
            document.getElementById('modal-phone').textContent = loc.phone;

            // --- L√≥gica de Inscripci√≥n ---
            const subscribeButton = document.getElementById('subscribe-button');
            
            // Reemplazar el bot√≥n con un clon para limpiar event listeners anteriores
            let newButton = subscribeButton.cloneNode(true);
            subscribeButton.parentNode.replaceChild(newButton, subscribeButton);

            // Comprobar si ya est√° inscripto a esta MATERIA
            const isSubscribed = subscriptions.some(sub => sub.subj === event.subj);

            if (isSubscribed) {
                newButton.textContent = 'Ya est√°s inscripto';
                newButton.disabled = true;
            } else {
                newButton.textContent = 'Inscribirme';
                newButton.disabled = false;
                newButton.addEventListener('click', () => {
                    handleSubscription(event);
                }, { once: true }); // 'once: true' asegura que el listener se dispare solo una vez
            }
            
            modal.classList.remove('hidden');
            // Prevenir scroll del body cuando el modal est√° abierto
            document.body.style.overflow = 'hidden';
        }

        function closeModal() {
            modal.classList.add('hidden');
            document.body.style.overflow = '';
        }

        // --- L√ìGICA DE INSCRIPCIONES ---
        
        // Maneja el clic en "Inscribirme"
        function handleSubscription(event) {
            subscriptions.push(event);
            saveSubscriptions(); // GUARDAR EN LOCALSTORAGE
            renderSubscriptions();
            renderCalendar(currentDate.getFullYear(), currentDate.getMonth()); // ACTUALIZAR CALENDARIO
            closeModal();
        }

        // Maneja el clic en "Cancelar"
        function removeSubscription(subject) {
            subscriptions = subscriptions.filter(sub => sub.subj !== subject);
            saveSubscriptions(); // GUARDAR EN LOCALSTORAGE
            renderSubscriptions();
            renderCalendar(currentDate.getFullYear(), currentDate.getMonth()); // ACTUALIZAR CALENDARIO
        }

        // Dibuja la lista de "Mis Inscripciones"
        function renderSubscriptions() {
            // Limpiar la lista
            subscriptionsListContainer.innerHTML = '';

            // Actualizar badge
            if (subscriptions.length > 0) {
                subscriptionsBadge.textContent = subscriptions.length;
                subscriptionsBadge.classList.remove('hidden');
            } else {
                subscriptionsBadge.classList.add('hidden');
            }

            if (subscriptions.length === 0) {
                // Mostrar mensaje de lista vac√≠a
                subscriptionsListContainer.appendChild(emptyListMessage);
                emptyListMessage.classList.remove('hidden');
            } else {
                emptyListMessage.classList.add('hidden');
                // Ocultar mensaje de lista vac√≠a
                if (!emptyListMessage.classList.contains('hidden')) {
                    emptyListMessage.classList.add('hidden');
                }

                // Ordenar suscripciones por fecha
                subscriptions.sort((a, b) => new Date(a.date) - new Date(b.date));

                subscriptions.forEach(sub => {
                    const itemEl = document.createElement('div');
                    itemEl.className = 'flex flex-col sm:flex-row items-start sm:items-center justify-between p-3 sm:p-4 border-b last:border-b-0 hover:bg-gray-50 transition-colors';
                    
                    const subDate = new Date(sub.date + 'T00:00:00').toLocaleDateString('es-ES', { weekday: 'long', day: 'numeric', month: 'long' });
                    const colorClass = getColorForSubject(sub.subj);

                    itemEl.innerHTML = `
                        <div class="flex items-start space-x-2 sm:space-x-3 mb-2 sm:mb-0 flex-1 min-w-0">
                            <div class="${colorClass} w-1 h-full rounded-full flex-shrink-0"></div>
                            <div class="min-w-0 flex-1">
                                <p class="font-bold text-gray-800 text-sm sm:text-base truncate">${sub.subj}</p>
                                <p class="text-xs sm:text-sm text-gray-600 mt-1">
                                    üìÖ ${subDate} - ${sub.time}h
                                </p>
                                <p class="text-xs sm:text-sm text-gray-600">
                                    üìç Div. ${sub.div} ¬∑ ${sub.prof || 'N/A'}
                                </p>
                            </div>
                        </div>
                        <button class="remove-sub-button w-full sm:w-auto mt-2 sm:mt-0 px-4 py-2 text-xs sm:text-sm text-white bg-red-500 rounded-lg font-medium hover:bg-red-600 active:bg-red-700 active:scale-95 transition-all shadow-sm flex-shrink-0">
                            Cancelar
                        </button>
                    `;
                    
                    // A√±adir listener al bot√≥n "Cancelar"
                    itemEl.querySelector('.remove-sub-button').addEventListener('click', () => {
                        if (confirm(`¬øCancelar inscripci√≥n a ${sub.subj}?`)) {
                            removeSubscription(sub.subj);
                        }
                    });
                    
                    subscriptionsListContainer.appendChild(itemEl);
                });
            }
        }


        // --- EVENT LISTENERS ---
        prevButton.addEventListener('click', () => {
            currentDate.setMonth(currentDate.getMonth() - 1);
            renderCalendar(currentDate.getFullYear(), currentDate.getMonth());
        });

        nextButton.addEventListener('click', () => {
            currentDate.setMonth(currentDate.getMonth() + 1);
            renderCalendar(currentDate.getFullYear(), currentDate.getMonth());
        });

        closeModalButton.addEventListener('click', closeModal);
        
        modal.addEventListener('click', (e) => {
            if (e.target === modal) {
                closeModal();
            }
        });

        // Prevenir cierre accidental con swipe en m√≥vil
        let modalStartY = 0;
        modal.addEventListener('touchstart', (e) => {
            modalStartY = e.touches[0].clientY;
        });
        
        modal.addEventListener('touchend', (e) => {
            const modalEndY = e.changedTouches[0].clientY;
            // Cerrar solo si swipe hacia abajo > 100px
            if (e.target === modal && modalEndY - modalStartY > 100) {
                closeModal();
            }
        });

        // Inicializaci√≥n
        document.addEventListener('DOMContentLoaded', () => {
            renderCalendar(currentDate.getFullYear(), currentDate.getMonth());
            renderSubscriptions(); // Esto mostrar√° las inscripciones guardadas
        });

    </script>
</body>
</html>
